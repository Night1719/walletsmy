<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ - Helpdesk Bot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .back-button {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .back-button:hover {
            opacity: 0.8;
        }
        
        .file-title {
            font-size: 16px;
            font-weight: 500;
        }
        
        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .expiry-info {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .viewer-container {
            height: calc(100vh - 60px);
            position: relative;
        }
        
        .pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .docx-viewer {
            width: 100%;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 16px;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 16px;
            color: #ff4444;
            text-align: center;
            padding: 20px;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .control-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
        }
        
        .control-button:hover {
            opacity: 0.7;
        }
        
        .page-info {
            font-size: 14px;
            margin: 0 10px;
        }
        
        .zoom-controls {
            display: flex;
            gap: 5px;
        }
        
        .security-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="security-badge">üîí –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</div>
    
    <div class="header">
        <div class="header-left">
            <button class="back-button" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="file-title" id="fileTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div class="header-right">
            <div class="expiry-info" id="expiryInfo">‚è∞ –°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ 40 –º–∏–Ω—É—Ç</div>
        </div>
    </div>
    
    <div class="viewer-container">
        <div id="viewer" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...</div>
    </div>

    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // Set theme colors
        document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
        document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
        document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#2481cc');
        document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f8f9fa');
        
        // Get parameters from URL
        const instructionType = '{{ instruction_type }}';
        const fileFormat = '{{ file_format }}';
        const token = '{{ token }}';
        
        let currentPage = 1;
        let totalPages = 1;
        let pdfDoc = null;
        let expiryTimer = null;
        
        // File type names
        const fileTypeNames = {
            '1c_ar2': '1–° AR2',
            '1c_dm': '1–° DM',
            'email_iphone': 'iPhone',
            'email_android': 'Android',
            'email_outlook': 'Outlook'
        };
        
        // Load and display file
        async function loadFile() {
            try {
                const response = await fetch(`/api/secure/convert/${token}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                document.getElementById('fileTitle').textContent = 
                    `${fileTypeNames[instructionType] || instructionType} (${fileFormat.toUpperCase()})`;
                
                if (fileFormat === 'pdf') {
                    await loadPDF(data.content);
                } else if (fileFormat === 'docx') {
                    await loadDOCX(data.content);
                } else {
                    throw new Error('Unsupported file format');
                }
                
                // Start expiry timer
                startExpiryTimer();
                
            } catch (error) {
                console.error('Error loading file:', error);
                document.getElementById('viewer').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞<br>' + error.message + '</div>';
            }
        }
        
        // Load PDF file
        async function loadPDF(base64Content) {
            try {
                // Configure PDF.js
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                // Convert base64 to Uint8Array
                const binaryString = atob(base64Content);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Load PDF
                pdfDoc = await pdfjsLib.getDocument({ data: bytes }).promise;
                totalPages = pdfDoc.numPages;
                
                // Render first page
                await renderPage(1);
                
                // Show controls for multi-page PDFs
                if (totalPages > 1) {
                    showControls();
                }
                
            } catch (error) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ PDF: ' + error.message);
            }
        }
        
        // Load DOCX file - convert to HTML for viewing
        async function loadDOCX(base64Content) {
            try {
                // Convert base64 to Uint8Array
                const binaryString = atob(base64Content);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Convert DOCX to HTML using Mammoth.js
                const result = await mammoth.convertToHtml({ arrayBuffer: bytes.buffer });
                
                const viewer = document.getElementById('viewer');
                viewer.innerHTML = `
                    <div class="docx-viewer">
                        <div style="padding: 20px; line-height: 1.6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                            ${result.value}
                        </div>
                    </div>
                `;
                
                // Show warnings if any
                if (result.messages && result.messages.length > 0) {
                    console.warn('DOCX conversion warnings:', result.messages);
                }
                
            } catch (error) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ DOCX: ' + error.message);
            }
        }
        
        // Render PDF page
        async function renderPage(pageNum) {
            try {
                const page = await pdfDoc.getPage(pageNum);
                const scale = 1.5;
                const viewport = page.getViewport({ scale });
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                
                const viewer = document.getElementById('viewer');
                viewer.innerHTML = '';
                viewer.appendChild(canvas);
                
                currentPage = pageNum;
                updatePageInfo();
                
            } catch (error) {
                throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ' + error.message);
            }
        }
        
        // Show PDF controls
        function showControls() {
            const controls = document.createElement('div');
            controls.className = 'controls';
            controls.innerHTML = `
                <button class="control-button" onclick="previousPage()">‚óÄ</button>
                <div class="page-info">
                    <span id="pageInfo">${currentPage} / ${totalPages}</span>
                </div>
                <button class="control-button" onclick="nextPage()">‚ñ∂</button>
                <div class="zoom-controls">
                    <button class="control-button" onclick="zoomOut()">üîç-</button>
                    <button class="control-button" onclick="zoomIn()">üîç+</button>
                </div>
            `;
            document.body.appendChild(controls);
        }
        
        // Update page info
        function updatePageInfo() {
            const pageInfo = document.getElementById('pageInfo');
            if (pageInfo) {
                pageInfo.textContent = `${currentPage} / ${totalPages}`;
            }
        }
        
        // Navigation functions
        async function previousPage() {
            if (currentPage > 1) {
                await renderPage(currentPage - 1);
            }
        }
        
        async function nextPage() {
            if (currentPage < totalPages) {
                await renderPage(currentPage + 1);
            }
        }
        
        // Zoom functions (simplified)
        function zoomIn() {
            // Implement zoom functionality
            console.log('Zoom in');
        }
        
        function zoomOut() {
            // Implement zoom functionality
            console.log('Zoom out');
        }
        
        // Start expiry timer
        function startExpiryTimer() {
            let timeLeft = 40 * 60; // 40 minutes in seconds
            
            const updateTimer = () => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                const expiryInfo = document.getElementById('expiryInfo');
                if (expiryInfo) {
                    expiryInfo.textContent = `‚è∞ –°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ ${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
                
                if (timeLeft <= 0) {
                    document.getElementById('viewer').innerHTML = `
                        <div class="error">
                            <div style="font-size: 48px; margin-bottom: 20px;">‚è∞</div>
                            <h3>–°—Å—ã–ª–∫–∞ –∏—Å—Ç–µ–∫–ª–∞</h3>
                            <p style="margin: 20px 0; color: var(--tg-theme-hint-color, #999999);">
                                –í—Ä–µ–º—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É –∏—Å—Ç–µ–∫–ª–æ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –±–æ—Ç—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å—Å—ã–ª–∫–∏.
                            </p>
                        </div>
                    `;
                    clearInterval(expiryTimer);
                    return;
                }
                
                timeLeft--;
            };
            
            updateTimer();
            expiryTimer = setInterval(updateTimer, 1000);
        }
        
        // Go back
        function goBack() {
            tg.close();
        }
        
        // Load file on page load
        document.addEventListener('DOMContentLoaded', loadFile);
    </script>
</body>
</html>