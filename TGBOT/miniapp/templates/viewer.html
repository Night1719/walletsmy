<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Просмотр инструкции - Helpdesk Bot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .back-button {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .back-button:hover {
            opacity: 0.8;
        }
        
        .file-title {
            font-size: 16px;
            font-weight: 500;
        }
        
        .header-right {
            display: flex;
            gap: 10px;
        }
        
        .action-button {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .action-button:hover {
            opacity: 0.8;
        }
        
        .viewer-container {
            height: calc(100vh - 60px);
            position: relative;
        }
        
        .pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .docx-viewer {
            width: 100%;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 16px;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 16px;
            color: #ff4444;
            text-align: center;
            padding: 20px;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .control-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
        }
        
        .control-button:hover {
            opacity: 0.7;
        }
        
        .page-info {
            font-size: 14px;
            margin: 0 10px;
        }
        
        .zoom-controls {
            display: flex;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <button class="back-button" onclick="goBack()">← Назад</button>
            <div class="file-title" id="fileTitle">Загрузка...</div>
        </div>
        <div class="header-right">
            <!-- Кнопки скачивания убраны -->
        </div>
    </div>
    
    <div class="viewer-container">
        <div id="viewer" class="loading">Загрузка файла...</div>
    </div>

    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // Set theme colors
        document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
        document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
        document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#2481cc');
        document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f8f9fa');
        
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const instructionType = '{{ instruction_type }}';
        const fileFormat = '{{ file_format }}';
        
        let currentPage = 1;
        let totalPages = 1;
        let pdfDoc = null;
        
        // File type names
        const fileTypeNames = {
            '1c_ar2': '1С AR2',
            '1c_dm': '1С DM',
            'email_iphone': 'iPhone',
            'email_android': 'Android',
            'email_outlook': 'Outlook'
        };
        
        // Load and display file
        async function loadFile() {
            try {
                const response = await fetch(`/api/convert/${instructionType}/${fileFormat}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                document.getElementById('fileTitle').textContent = 
                    `${fileTypeNames[instructionType] || instructionType} (${fileFormat.toUpperCase()})`;
                
                if (fileFormat === 'pdf') {
                    await loadPDF(data.content);
                } else if (fileFormat === 'docx') {
                    await loadDOCX(data.content);
                } else {
                    throw new Error('Unsupported file format');
                }
                
            } catch (error) {
                console.error('Error loading file:', error);
                document.getElementById('viewer').innerHTML = 
                    '<div class="error">Ошибка загрузки файла<br>' + error.message + '</div>';
            }
        }
        
        // Load PDF file
        async function loadPDF(base64Content) {
            try {
                // Configure PDF.js
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                // Convert base64 to Uint8Array
                const binaryString = atob(base64Content);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Load PDF
                pdfDoc = await pdfjsLib.getDocument({ data: bytes }).promise;
                totalPages = pdfDoc.numPages;
                
                // Render first page
                await renderPage(1);
                
                // Show controls for multi-page PDFs
                if (totalPages > 1) {
                    showControls();
                }
                
            } catch (error) {
                throw new Error('Ошибка загрузки PDF: ' + error.message);
            }
        }
        
        // Render PDF page
        async function renderPage(pageNum) {
            try {
                const page = await pdfDoc.getPage(pageNum);
                const scale = 1.5;
                const viewport = page.getViewport({ scale });
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                
                const viewer = document.getElementById('viewer');
                viewer.innerHTML = '';
                viewer.appendChild(canvas);
                
                currentPage = pageNum;
                updatePageInfo();
                
            } catch (error) {
                throw new Error('Ошибка отображения страницы: ' + error.message);
            }
        }
        
        // Load DOCX file - convert to HTML for viewing
        async function loadDOCX(base64Content) {
            try {
                // Convert base64 to Uint8Array
                const binaryString = atob(base64Content);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Convert DOCX to HTML using Mammoth.js
                const result = await mammoth.convertToHtml({ arrayBuffer: bytes.buffer });
                
                const viewer = document.getElementById('viewer');
                viewer.innerHTML = `
                    <div class="docx-viewer">
                        <div style="padding: 20px; line-height: 1.6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                            ${result.value}
                        </div>
                    </div>
                `;
                
                // Show warnings if any
                if (result.messages && result.messages.length > 0) {
                    console.warn('DOCX conversion warnings:', result.messages);
                }
                
            } catch (error) {
                console.error('Error loading DOCX:', error);
                const viewer = document.getElementById('viewer');
                viewer.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
                        <h3>Ошибка загрузки</h3>
                        <p style="margin: 20px 0; color: var(--tg-theme-hint-color, #999999);">
                            Не удалось загрузить документ Word: ${error.message}
                        </p>
                    </div>
                `;
            }
        }
        
        // Show PDF controls
        function showControls() {
            const controls = document.createElement('div');
            controls.className = 'controls';
            controls.innerHTML = `
                <button class="control-button" onclick="previousPage()">◀</button>
                <div class="page-info">
                    <span id="pageInfo">${currentPage} / ${totalPages}</span>
                </div>
                <button class="control-button" onclick="nextPage()">▶</button>
                <div class="zoom-controls">
                    <button class="control-button" onclick="zoomOut()">🔍-</button>
                    <button class="control-button" onclick="zoomIn()">🔍+</button>
                </div>
            `;
            document.body.appendChild(controls);
        }
        
        // Update page info
        function updatePageInfo() {
            const pageInfo = document.getElementById('pageInfo');
            if (pageInfo) {
                pageInfo.textContent = `${currentPage} / ${totalPages}`;
            }
        }
        
        // Navigation functions
        async function previousPage() {
            if (currentPage > 1) {
                await renderPage(currentPage - 1);
            }
        }
        
        async function nextPage() {
            if (currentPage < totalPages) {
                await renderPage(currentPage + 1);
            }
        }
        
        // Zoom functions (simplified)
        function zoomIn() {
            // Implement zoom functionality
            console.log('Zoom in');
        }
        
        function zoomOut() {
            // Implement zoom functionality
            console.log('Zoom out');
        }
        
        // Download function removed - files are displayed inline
        
        // Go back
        function goBack() {
            window.history.back();
        }
        
        // Load file on page load
        document.addEventListener('DOMContentLoaded', loadFile);
    </script>
</body>
</html>