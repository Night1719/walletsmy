{% extends "create_survey.html" %}

{% block title %}Редактировать опрос - BG Survey Platform{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2 class="fw-bold text-dark">
            <i class="fas fa-edit text-danger me-2"></i>
            Редактировать опрос
        </h2>
        <p class="text-muted">Внесите изменения в ваш опрос</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <form method="POST" id="surveyForm">
                    <!-- Основная информация -->
                    <div class="mb-4">
                        <h5 class="text-dark mb-3">
                            <i class="fas fa-info-circle text-danger me-2"></i>
                            Основная информация
                        </h5>
                        
                        <div class="mb-3">
                            <label for="title" class="form-label">Название опроса *</label>
                            <input type="text" class="form-control" id="title" name="title" value="{{ survey.title }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Описание</label>
                            <textarea class="form-control" id="description" name="description" rows="3" placeholder="Краткое описание цели опроса...">{{ survey.description }}</textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="is_anonymous" name="is_anonymous" {% if survey.is_anonymous %}checked{% endif %}>
                                    <label class="form-check-label" for="is_anonymous">
                                        Анонимный опрос
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        IP-адреса будут отслеживаться для статистики
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="require_auth" name="require_auth" {% if survey.require_auth %}checked{% endif %}>
                                    <label class="form-check-label" for="require_auth">
                                        Требуется авторизация
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Только авторизованные пользователи
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="require_name" name="require_name" {% if survey.require_name %}checked{% endif %}>
                                    <label class="form-check-label" for="require_name">
                                        Запросить имя
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Запрос имени в конце опроса
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Вопросы -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="text-dark mb-0">
                                <i class="fas fa-question-circle text-danger me-2"></i>
                                Вопросы
                            </h5>
                            <button type="button" class="btn btn-outline-danger" id="addQuestionBtn">
                                <i class="fas fa-plus me-1"></i>Добавить вопрос
                            </button>
                        </div>
                        
                        <div id="questionsContainer">
                            <!-- Вопросы будут добавляться сюда -->
                        </div>
                        
                        <!-- Скрытое поле для вопросов -->
                        <input type="hidden" name="questions" id="questionsData">
                    </div>
                    
                    <!-- Кнопки -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Отмена
                        </a>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-save me-1"></i>Сохранить изменения
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Предварительный просмотр -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-eye text-danger me-2"></i>
                    Предварительный просмотр
                </h6>
            </div>
            <div class="card-body">
                <div id="previewContainer">
                    <p class="text-muted text-center">Добавьте вопросы для предварительного просмотра</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Шаблон вопроса -->
<template id="questionTemplate">
    <div class="question-item border rounded p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">
                <span class="badge bg-primary me-2 question-number">1</span>
                Вопрос
            </h6>
            <button type="button" class="btn btn-outline-danger btn-sm remove-question">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Текст вопроса *</label>
            <input type="text" class="form-control question-text" required>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Тип вопроса *</label>
            <select class="form-select question-type">
                <option value="text">Текст (строка)</option>
                <option value="text_paragraph">Текст (Абзац)</option>
                <option value="single_choice">Один из списка</option>
                <option value="multiple_choice">Несколько из списка</option>
                <option value="dropdown">Раскрывающийся список</option>
                <option value="scale">Шкала</option>
                <option value="rating">Оценка</option>
                <option value="grid">Сетка</option>
                <option value="checkbox_grid">Сетка из флажков</option>
                <option value="date">Дата</option>
                <option value="time">Время</option>
            </select>
        </div>
        
        <div class="question-options" style="display: none;">
            <label class="form-label">Варианты ответов</label>
            <div class="options-container">
                <div class="input-group mb-2">
                    <input type="text" class="form-control option-input" placeholder="Вариант 1">
                    <button type="button" class="btn btn-outline-secondary remove-option">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary add-option">
                <i class="fas fa-plus me-1"></i>Добавить вариант
            </button>
        </div>
        
        <!-- Конфигурация рейтинга/шкалы -->
        <div class="question-rating-config" style="display: none;">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Минимальное значение</label>
                    <input type="number" class="form-control rating-min-input" value="1" min="1">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Максимальное значение</label>
                    <input type="number" class="form-control rating-max-input" value="5" min="2">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Шаг</label>
                    <input type="number" class="form-control rating-step-input" value="1" min="1">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <label class="form-label">Подпись для минимального значения</label>
                    <input type="text" class="form-control rating-label-min-input" placeholder="Например: Очень плохо">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Подпись для максимального значения</label>
                    <input type="text" class="form-control rating-label-max-input" placeholder="Например: Отлично">
                </div>
            </div>
        </div>
        
        <!-- Конфигурация сетки -->
        <div class="question-grid-config" style="display: none;">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Строки (вопросы)</label>
                    <div class="grid-rows-container">
                        <div class="input-group mb-2">
                            <input type="text" class="form-control grid-row-input" placeholder="Строка 1">
                            <button type="button" class="btn btn-outline-secondary remove-grid-row">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary add-grid-row">
                        <i class="fas fa-plus me-1"></i>Добавить строку
                    </button>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Столбцы (варианты ответов)</label>
                    <div class="grid-columns-container">
                        <div class="input-group mb-2">
                            <input type="text" class="form-control grid-column-input" placeholder="Столбец 1">
                            <button type="button" class="btn btn-outline-secondary remove-grid-column">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary add-grid-column">
                        <i class="fas fa-plus me-1"></i>Добавить столбец
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Дополнительные настройки -->
        <div class="question-advanced-settings mt-3">
            <div class="form-check">
                <input class="form-check-input question-required" type="checkbox" id="question_required_{{ questionCounter }}" checked>
                <label class="form-check-label" for="question_required_{{ questionCounter }}">
                    Обязательный вопрос
                </label>
            </div>
            
            <div class="question-other-option mt-2" style="display: none;">
                <div class="form-check">
                    <input class="form-check-input question-allow-other" type="checkbox" id="question_allow_other_{{ questionCounter }}">
                    <label class="form-check-label" for="question_allow_other_{{ questionCounter }}">
                        Разрешить "Другой вариант"
                    </label>
                </div>
                <div class="mt-2">
                    <input type="text" class="form-control question-other-text" placeholder="Текст для варианта 'Другой'" value="Другой вариант">
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
let questionCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    const addQuestionBtn = document.getElementById('addQuestionBtn');
    const questionsContainer = document.getElementById('questionsContainer');
    const questionTemplate = document.getElementById('questionTemplate');
    const questionsData = document.getElementById('questionsData');
    const surveyForm = document.getElementById('surveyForm');
    
    // Загружаем существующие вопросы
    loadExistingQuestions();
    
    // Добавить вопрос
    addQuestionBtn.addEventListener('click', function() {
        addQuestion();
    });
    
    // Обработка отправки формы
    surveyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        collectQuestionsData();
        this.submit();
    });
});

function loadExistingQuestions() {
    const questions = {{ survey.questions | tojson }};
    questions.forEach(question => {
        addQuestion(question);
    });
}

function addQuestion(questionData = null) {
    questionCounter++;
    const template = document.getElementById('questionTemplate');
    const clone = template.content.cloneNode(true);
    
    // Установить номер вопроса
    clone.querySelector('.question-number').textContent = questionCounter;
    
    // Добавить обработчики событий
    const questionItem = clone.querySelector('.question-item');
    const questionType = questionItem.querySelector('.question-type');
    const questionOptions = questionItem.querySelector('.question-options');
    const removeBtn = questionItem.querySelector('.remove-question');
    const addOptionBtn = questionItem.querySelector('.add-option');
    
    // Заполнить данные, если они есть
    if (questionData) {
        questionItem.querySelector('.question-text').value = questionData.text || '';
        questionType.value = questionData.type || 'text';
        
        // Заполнить настройки рейтинга
        if (questionData.rating_min) {
            questionItem.querySelector('.rating-min-input').value = questionData.rating_min;
        }
        if (questionData.rating_max) {
            questionItem.querySelector('.rating-max-input').value = questionData.rating_max;
        }
        if (questionData.rating_labels && questionData.rating_labels.length >= 2) {
            questionItem.querySelector('.rating-label-min-input').value = questionData.rating_labels[0] || '';
            questionItem.querySelector('.rating-label-max-input').value = questionData.rating_labels[1] || '';
        }
        
        // Заполнить обязательность
        if (questionData.is_required !== undefined) {
            questionItem.querySelector('.question-required').checked = questionData.is_required;
        }
        
        // Заполнить опцию "Другой"
        if (questionData.allow_other !== undefined) {
            questionItem.querySelector('.question-allow-other').checked = questionData.allow_other;
        }
        if (questionData.other_text) {
            questionItem.querySelector('.question-other-text').value = questionData.other_text;
        }
        
        // Заполнить варианты ответов
        if (questionData.options && questionData.options.length > 0) {
            questionData.options.forEach((option, index) => {
                if (index === 0) {
                    questionItem.querySelector('.option-input').value = option;
                } else {
                    addOption(questionItem, option);
                }
            });
        }
        
        // Заполнить строки и столбцы сетки
        if (questionData.grid_rows && questionData.grid_rows.length > 0) {
            questionData.grid_rows.forEach((row, index) => {
                if (index === 0) {
                    questionItem.querySelector('.grid-row-input').value = row;
                } else {
                    addGridRow(questionItem, row);
                }
            });
        }
        
        if (questionData.grid_columns && questionData.grid_columns.length > 0) {
            questionData.grid_columns.forEach((column, index) => {
                if (index === 0) {
                    questionItem.querySelector('.grid-column-input').value = column;
                } else {
                    addGridColumn(questionItem, column);
                }
            });
        }
    }
    
    // Показать/скрыть варианты ответов и конфигурацию
    questionType.addEventListener('change', function() {
        const questionGridConfig = questionItem.querySelector('.question-grid-config');
        const questionRatingConfig = questionItem.querySelector('.question-rating-config');
        const questionOtherOption = questionItem.querySelector('.question-other-option');
        
        // Скрыть все конфигурации
        questionOptions.style.display = 'none';
        questionGridConfig.style.display = 'none';
        questionRatingConfig.style.display = 'none';
        questionOtherOption.style.display = 'none';
        
        if (this.value === 'multiple_choice' || this.value === 'single_choice' || this.value === 'dropdown') {
            questionOptions.style.display = 'block';
            questionOtherOption.style.display = 'block';
        } else if (this.value === 'grid' || this.value === 'checkbox_grid') {
            questionGridConfig.style.display = 'block';
        } else if (this.value === 'rating' || this.value === 'scale') {
            questionRatingConfig.style.display = 'block';
        }
        updatePreview();
    });
    
    // Удалить вопрос
    removeBtn.addEventListener('click', function() {
        if (document.querySelectorAll('.question-item').length > 1) {
            questionItem.remove();
            updatePreview();
        }
    });
    
    // Добавить вариант ответа
    addOptionBtn.addEventListener('click', function() {
        addOption(questionItem);
    });
    
    // Удалить вариант ответа
    questionItem.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-option')) {
            if (e.target.closest('.options-container').children.length > 1) {
                e.target.closest('.input-group').remove();
            }
        }
    });
    
    // Обработчики для конфигурации сетки
    const addGridRowBtn = questionItem.querySelector('.add-grid-row');
    const addGridColumnBtn = questionItem.querySelector('.add-grid-column');
    
    if (addGridRowBtn) {
        addGridRowBtn.addEventListener('click', function() {
            addGridRow(questionItem);
        });
    }
    
    if (addGridColumnBtn) {
        addGridColumnBtn.addEventListener('click', function() {
            addGridColumn(questionItem);
        });
    }
    
    // Удалить строку/столбец сетки
    questionItem.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-grid-row')) {
            if (e.target.closest('.grid-rows-container').children.length > 1) {
                e.target.closest('.input-group').remove();
            }
        } else if (e.target.classList.contains('remove-grid-column')) {
            if (e.target.closest('.grid-columns-container').children.length > 1) {
                e.target.closest('.input-group').remove();
            }
        }
    });
    
    document.getElementById('questionsContainer').appendChild(clone);
    
    // Триггерим событие change для правильного отображения конфигурации
    if (questionData) {
        questionType.dispatchEvent(new Event('change'));
    }
    
    updatePreview();
}

function addOption(questionItem, value = '') {
    const optionsContainer = questionItem.querySelector('.options-container');
    const optionCount = optionsContainer.children.length + 1;
    
    const optionDiv = document.createElement('div');
    optionDiv.className = 'input-group mb-2';
    optionDiv.innerHTML = `
        <input type="text" class="form-control option-input" placeholder="Вариант ${optionCount}" value="${value}">
        <button type="button" class="btn btn-outline-secondary remove-option">
            <i class="fas fa-minus"></i>
        </button>
    `;
    
    optionsContainer.appendChild(optionDiv);
}

function addGridRow(questionItem, value = '') {
    const gridRowsContainer = questionItem.querySelector('.grid-rows-container');
    const rowCount = gridRowsContainer.children.length + 1;
    
    const rowDiv = document.createElement('div');
    rowDiv.className = 'input-group mb-2';
    rowDiv.innerHTML = `
        <input type="text" class="form-control grid-row-input" placeholder="Строка ${rowCount}" value="${value}">
        <button type="button" class="btn btn-outline-secondary remove-grid-row">
            <i class="fas fa-minus"></i>
        </button>
    `;
    
    gridRowsContainer.appendChild(rowDiv);
}

function addGridColumn(questionItem, value = '') {
    const gridColumnsContainer = questionItem.querySelector('.grid-columns-container');
    const columnCount = gridColumnsContainer.children.length + 1;
    
    const columnDiv = document.createElement('div');
    columnDiv.className = 'input-group mb-2';
    columnDiv.innerHTML = `
        <input type="text" class="form-control grid-column-input" placeholder="Столбец ${columnCount}" value="${value}">
        <button type="button" class="btn btn-outline-secondary remove-grid-column">
            <i class="fas fa-minus"></i>
        </button>
    `;
    
    gridColumnsContainer.appendChild(columnDiv);
}

function updatePreview() {
    const previewContainer = document.getElementById('previewContainer');
    const questions = document.querySelectorAll('.question-item');
    
    if (questions.length === 0) {
        previewContainer.innerHTML = '<p class="text-muted text-center">Добавьте вопросы для предварительного просмотра</p>';
        return;
    }
    
    let previewHTML = '';
    questions.forEach((question, index) => {
        const questionText = question.querySelector('.question-text').value || `Вопрос ${index + 1}`;
        const questionType = question.querySelector('.question-type').value;
        
        previewHTML += `
            <div class="mb-3 p-2 border-start border-3 border-primary">
                <strong>${questionText}</strong>
                <br><small class="text-muted">${getQuestionTypeName(questionType)}</small>
        `;
        
        if (questionType === 'multiple_choice' || questionType === 'single_choice') {
            const options = question.querySelectorAll('.option-input');
            if (options.length > 0) {
                previewHTML += '<div class="mt-2">';
                options.forEach(option => {
                    if (option.value) {
                        const inputType = questionType === 'single_choice' ? 'radio' : 'checkbox';
                        previewHTML += `<div class="form-check"><input class="form-check-input" type="${inputType}" disabled><label class="form-check-label small">${option.value}</label></div>`;
                    }
                });
                previewHTML += '</div>';
            }
        } else if (questionType === 'dropdown') {
            previewHTML += '<div class="mt-2"><small class="text-muted">Выпадающий список</small></div>';
        } else if (questionType === 'rating' || questionType === 'scale') {
            const ratingMin = question.querySelector('.rating-min-input') ? question.querySelector('.rating-min-input').value : 1;
            const ratingMax = question.querySelector('.rating-max-input') ? question.querySelector('.rating-max-input').value : 5;
            const labelMin = question.querySelector('.rating-label-min-input') ? question.querySelector('.rating-label-min-input').value : '';
            const labelMax = question.querySelector('.rating-label-max-input') ? question.querySelector('.rating-label-max-input').value : '';
            
            previewHTML += '<div class="mt-2">';
            previewHTML += `<small class="text-muted">Рейтинг от ${ratingMin} до ${ratingMax}</small>`;
            if (labelMin || labelMax) {
                previewHTML += `<br><small class="text-muted">${labelMin} - ${labelMax}</small>`;
            }
            previewHTML += '</div>';
        } else if (questionType === 'grid' || questionType === 'checkbox_grid') {
            const gridRows = question.querySelectorAll('.grid-row-input');
            const gridColumns = question.querySelectorAll('.grid-column-input');
            if (gridRows.length > 0 && gridColumns.length > 0) {
                previewHTML += '<div class="mt-2">';
                previewHTML += '<table class="table table-sm table-bordered">';
                previewHTML += '<thead><tr><th></th>';
                gridColumns.forEach(column => {
                    if (column.value.trim()) {
                        previewHTML += `<th class="text-center">${column.value.trim()}</th>`;
                    }
                });
                previewHTML += '</tr></thead><tbody>';
                gridRows.forEach(row => {
                    if (row.value.trim()) {
                        previewHTML += `<tr><td><strong>${row.value.trim()}</strong></td>`;
                        gridColumns.forEach(() => {
                            previewHTML += '<td class="text-center">○</td>';
                        });
                        previewHTML += '</tr>';
                    }
                });
                previewHTML += '</tbody></table>';
                previewHTML += '</div>';
            } else {
                previewHTML += '<div class="mt-2"><small class="text-muted">Настройте строки и столбцы сетки</small></div>';
            }
        } else if (questionType === 'date') {
            previewHTML += '<div class="mt-2"><small class="text-muted">Поле выбора даты</small></div>';
        } else if (questionType === 'time') {
            previewHTML += '<div class="mt-2"><small class="text-muted">Поле выбора времени</small></div>';
        } else if (questionType === 'text_paragraph') {
            previewHTML += '<div class="mt-2"><small class="text-muted">Многострочное текстовое поле</small></div>';
        } else {
            previewHTML += '<div class="mt-2"><small class="text-muted">Однострочное текстовое поле</small></div>';
        }
        
        previewHTML += '</div>';
    });
    
    previewContainer.innerHTML = previewHTML;
}

function getQuestionTypeName(type) {
    const types = {
        'text': 'Текст (строка)',
        'text_paragraph': 'Текст (Абзац)',
        'single_choice': 'Один из списка',
        'multiple_choice': 'Несколько из списка',
        'dropdown': 'Раскрывающийся список',
        'scale': 'Шкала',
        'rating': 'Оценка',
        'grid': 'Сетка',
        'checkbox_grid': 'Сетка из флажков',
        'date': 'Дата',
        'time': 'Время'
    };
    return types[type] || type;
}

function collectQuestionsData() {
    const questions = [];
    document.querySelectorAll('.question-item').forEach(question => {
        const questionData = {
            text: question.querySelector('.question-text').value,
            type: question.querySelector('.question-type').value,
            options: [],
            is_required: question.querySelector('.question-required') ? question.querySelector('.question-required').checked : false,
            allow_other: question.querySelector('.question-allow-other') ? question.querySelector('.question-allow-other').checked : false,
            other_text: question.querySelector('.question-other-text') ? question.querySelector('.question-other-text').value : 'Другой вариант',
            rating_min: question.querySelector('.rating-min-input') ? parseInt(question.querySelector('.rating-min-input').value) : 1,
            rating_max: question.querySelector('.rating-max-input') ? parseInt(question.querySelector('.rating-max-input').value) : 5,
            rating_step: question.querySelector('.rating-step-input') ? parseInt(question.querySelector('.rating-step-input').value) : 1,
            rating_labels: [],
            grid_rows: [],
            grid_columns: []
        };
        
        // Собираем подписи для рейтинга
        const labelMin = question.querySelector('.rating-label-min-input');
        const labelMax = question.querySelector('.rating-label-max-input');
        if (labelMin && labelMax) {
            questionData.rating_labels = [labelMin.value, labelMax.value];
        }
        
        if (questionData.type === 'multiple_choice' || questionData.type === 'single_choice' || questionData.type === 'dropdown') {
            question.querySelectorAll('.option-input').forEach(option => {
                if (option.value.trim()) {
                    questionData.options.push(option.value.trim());
                }
            });
        } else if (questionData.type === 'grid' || questionData.type === 'checkbox_grid') {
            // Собираем строки сетки
            question.querySelectorAll('.grid-row-input').forEach(row => {
                if (row.value.trim()) {
                    questionData.grid_rows.push(row.value.trim());
                }
            });
            
            // Собираем столбцы сетки
            question.querySelectorAll('.grid-column-input').forEach(column => {
                if (column.value.trim()) {
                    questionData.grid_columns.push(column.value.trim());
                }
            });
        }
        
        questions.push(questionData);
    });
    
    document.getElementById('questionsData').value = JSON.stringify(questions);
}

// Обновлять предварительный просмотр при изменении полей
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('question-text') || 
        e.target.classList.contains('option-input') ||
        e.target.classList.contains('grid-row-input') ||
        e.target.classList.contains('grid-column-input') ||
        e.target.classList.contains('rating-min-input') ||
        e.target.classList.contains('rating-max-input') ||
        e.target.classList.contains('rating-step-input') ||
        e.target.classList.contains('rating-label-min-input') ||
        e.target.classList.contains('rating-label-max-input') ||
        e.target.classList.contains('question-other-text')) {
        updatePreview();
    }
});
</script>
{% endblock %}