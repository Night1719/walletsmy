{% extends "base.html" %}

{% block title %}Кросс-анализ - BG Survey Platform{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2 class="fw-bold text-dark">
            <i class="fas fa-project-diagram text-danger me-2"></i>
            Кросс-анализ
        </h2>
        <p class="text-muted">Сравнительный анализ между опросами и пользователями</p>
    </div>
</div>

<!-- Фильтры -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-filter text-danger me-2"></i>
                    Фильтры анализа
                </h6>
            </div>
            <div class="card-body">
                <form method="GET" id="filterForm">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Период</label>
                            <select class="form-select" name="period" onchange="document.getElementById('filterForm').submit()">
                                <option value="week" {% if period == 'week' %}selected{% endif %}>Неделя</option>
                                <option value="month" {% if period == 'month' %}selected{% endif %}>Месяц</option>
                                <option value="quarter" {% if period == 'quarter' %}selected{% endif %}>Квартал</option>
                                <option value="year" {% if period == 'year' %}selected{% endif %}>Год</option>
                                <option value="all" {% if period == 'all' %}selected{% endif %}>Все время</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Тип опроса</label>
                            <select class="form-select" name="survey_type" onchange="document.getElementById('filterForm').submit()">
                                <option value="all" {% if survey_type == 'all' %}selected{% endif %}>Все типы</option>
                                <option value="anonymous" {% if survey_type == 'anonymous' %}selected{% endif %}>Анонимные</option>
                                <option value="auth" {% if survey_type == 'auth' %}selected{% endif %}>С авторизацией</option>
                                <option value="name" {% if survey_type == 'name' %}selected{% endif %}>С запросом имени</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Пользователь</label>
                            <select class="form-select" name="user_id" onchange="document.getElementById('filterForm').submit()">
                                <option value="all" {% if user_id == 'all' %}selected{% endif %}>Все пользователи</option>
                                {% for user in users %}
                                <option value="{{ user.id }}" {% if user_id == user.id|string %}selected{% endif %}>{{ user.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-search me-1"></i>Применить
                                </button>
                                <a href="{{ url_for('cross_analysis') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>Сбросить
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Сравнение опросов -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-balance-scale text-danger me-2"></i>
                    Сравнение опросов
                </h6>
            </div>
            <div class="card-body">
                <canvas id="surveysComparisonChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Анализ эффективности типов опросов -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar text-danger me-2"></i>
                    Эффективность типов опросов
                </h6>
            </div>
            <div class="card-body">
                <canvas id="effectivenessChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-clock text-danger me-2"></i>
                    Время прохождения по типам
                </h6>
            </div>
            <div class="card-body">
                <canvas id="timeChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Корреляционный анализ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-link text-danger me-2"></i>
                    Корреляционный анализ
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Метрика 1</th>
                                <th>Метрика 2</th>
                                <th>Корреляция</th>
                                <th>Интерпретация</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for correlation in correlations %}
                            <tr>
                                <td>{{ correlation.metric1 }}</td>
                                <td>{{ correlation.metric2 }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if correlation.value > 0.5 else 'warning' if correlation.value > 0.3 else 'secondary' }}">
                                        {{ "%.3f"|format(correlation.value) }}
                                    </span>
                                </td>
                                <td>
                                    {% if correlation.value > 0.7 %}
                                        <span class="text-success">Сильная положительная</span>
                                    {% elif correlation.value > 0.3 %}
                                        <span class="text-warning">Умеренная положительная</span>
                                    {% elif correlation.value > -0.3 %}
                                        <span class="text-secondary">Слабая</span>
                                    {% elif correlation.value > -0.7 %}
                                        <span class="text-warning">Умеренная отрицательная</span>
                                    {% else %}
                                        <span class="text-danger">Сильная отрицательная</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Статистика по пользователям -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-users text-danger me-2"></i>
                    Статистика по пользователям
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <h4 class="text-danger">{{ user_stats.avg_surveys_per_user }}</h4>
                        <p class="text-muted">Среднее опросов на пользователя</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4 class="text-danger">{{ user_stats.avg_responses_per_user }}</h4>
                        <p class="text-muted">Среднее ответов на пользователя</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4 class="text-danger">{{ user_stats.most_active_user }}</h4>
                        <p class="text-muted">Самый активный пользователь</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4 class="text-danger">{{ user_stats.avg_completion_time }}</h4>
                        <p class="text-muted">Среднее время прохождения (мин)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Кнопка возврата -->
<div class="row">
    <div class="col">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Вернуться в панель управления
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// График сравнения опросов
const comparisonCtx = document.getElementById('surveysComparisonChart').getContext('2d');
new Chart(comparisonCtx, {
    type: 'bar',
    data: {
        labels: {{ comparison_labels | tojson }},
        datasets: [{
            label: 'Количество ответов',
            data: {{ comparison_data | tojson }},
            backgroundColor: '#dc3545',
            borderColor: '#dc3545',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// График эффективности типов опросов
const effectivenessCtx = document.getElementById('effectivenessChart').getContext('2d');
new Chart(effectivenessCtx, {
    type: 'doughnut',
    data: {
        labels: {{ effectiveness_labels | tojson }},
        datasets: [{
            data: {{ effectiveness_data | tojson }},
            backgroundColor: [
                '#dc3545',
                '#28a745',
                '#ffc107',
                '#17a2b8'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// График времени прохождения
const timeCtx = document.getElementById('timeChart').getContext('2d');
new Chart(timeCtx, {
    type: 'line',
    data: {
        labels: {{ time_labels | tojson }},
        datasets: [{
            label: 'Среднее время (мин)',
            data: {{ time_data | tojson }},
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>
{% endblock %}