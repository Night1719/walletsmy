{% extends "base.html" %}

{% block title %}Аналитика опроса "{{ survey.title }}" - BG Survey Platform{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('analytics_dashboard') }}">Аналитика</a></li>
                <li class="breadcrumb-item active">{{ survey.title }}</li>
            </ol>
        </nav>
        <h2 class="fw-bold text-dark">
            <i class="fas fa-chart-bar text-danger me-2"></i>
            Аналитика опроса
        </h2>
        <p class="text-muted">{{ survey.description or 'Детальный анализ результатов опроса' }}</p>
    </div>
</div>

<!-- Основные метрики опроса -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ analytics.total_responses }}</h4>
                        <p class="mb-0">Всего ответов</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-comments fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ "%.1f"|format(analytics.completion_rate) }}%</h4>
                        <p class="mb-0">Завершенность</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ "%.0f"|format(analytics.avg_completion_time / 60) }} мин</h4>
                        <p class="mb-0">Среднее время</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ analytics.geo_analytics.unique_ips if analytics.geo_analytics else 0 }}</h4>
                        <p class="mb-0">Уникальных IP</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-map-marker-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Временная аналитика -->
{% if analytics.time_analytics %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Ответы по дням
                </h5>
            </div>
            <div class="card-body">
                <canvas id="dailyChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Ответы по часам
                </h5>
            </div>
            <div class="card-body">
                <canvas id="hourlyChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Анализ по вопросам -->
<div class="row">
    <div class="col">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>
                    Анализ по вопросам
                </h5>
            </div>
            <div class="card-body">
                {% for q_analytics in analytics.question_analytics %}
                <div class="mb-4 p-3 border rounded">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="text-dark mb-2">
                                <i class="fas fa-{{ get_question_icon(q_analytics.question.type) }} text-danger me-2"></i>
                                {{ q_analytics.question.text }}
                            </h6>
                            <p class="text-muted mb-2">
                                <small>
                                    Тип: {{ get_question_type_name(q_analytics.question.type) }} | 
                                    Ответов: {{ q_analytics.total_answers }} | 
                                    Процент ответов: {{ "%.1f"|format(q_analytics.response_rate) }}%
                                </small>
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="showQuestionChart({{ q_analytics.question.id }})">
                                    <i class="fas fa-chart-pie"></i> График
                                </button>
                                <button class="btn btn-outline-info" onclick="showQuestionDetails({{ q_analytics.question.id }})">
                                    <i class="fas fa-info-circle"></i> Детали
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Данные вопроса -->
                    <div class="mt-3">
                        {% if q_analytics.question.type in ['single_choice', 'multiple_choice', 'dropdown'] %}
                            <div class="row">
                                {% for option, count in q_analytics.data.items() %}
                                <div class="col-md-6 mb-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>{{ option }}</span>
                                        <div class="d-flex align-items-center">
                                            <div class="progress me-2" style="width: 100px; height: 20px;">
                                                <div class="progress-bar bg-danger" 
                                                     style="width: {{ (count / q_analytics.total_answers * 100) if q_analytics.total_answers > 0 else 0 }}%"></div>
                                            </div>
                                            <span class="badge bg-secondary">{{ count }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% elif q_analytics.question.type == 'checkbox' %}
                            <div class="row">
                                {% for option, count in q_analytics.data.items() %}
                                <div class="col-md-6 mb-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>{{ option }}</span>
                                        <div class="d-flex align-items-center">
                                            <div class="progress me-2" style="width: 100px; height: 20px;">
                                                <div class="progress-bar bg-warning" 
                                                     style="width: {{ (count / q_analytics.total_answers * 100) if q_analytics.total_answers > 0 else 0 }}%"></div>
                                            </div>
                                            <span class="badge bg-secondary">{{ count }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% elif q_analytics.question.type in ['rating', 'scale'] %}
                            {% if q_analytics.data %}
                            <div class="row">
                                <div class="col-md-4">
                                    <p><strong>Средняя оценка:</strong> {{ "%.2f"|format(q_analytics.data.avg) }}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Минимум:</strong> {{ q_analytics.data.min }}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Максимум:</strong> {{ q_analytics.data.max }}</p>
                                </div>
                            </div>
                            <div class="mt-2">
                                <canvas id="ratingChart{{ q_analytics.question.id }}" height="100"></canvas>
                            </div>
                            {% endif %}
                        {% elif q_analytics.question.type in ['text', 'text_paragraph'] %}
                            <div class="row">
                                <div class="col-md-4">
                                    <p><strong>Всего ответов:</strong> {{ q_analytics.data.total_texts }}</p>
                                </div>
                                <div class="col-md-4">
                                    <p><strong>Средняя длина:</strong> {{ "%.0f"|format(q_analytics.data.avg_length) }} символов</p>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-outline-primary btn-sm" onclick="showTextAnswers({{ q_analytics.question.id }})">
                                        <i class="fas fa-eye"></i> Показать ответы
                                    </button>
                                </div>
                            </div>
                        {% elif q_analytics.question.type in ['grid', 'checkbox_grid'] %}
                            <div class="row">
                                <div class="col-md-12">
                                    <p><strong>Заполненных ячеек:</strong> {{ q_analytics.data|length }}</p>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Ячейка</th>
                                                    <th>Количество</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for cell, count in q_analytics.data.items() %}
                                                <tr>
                                                    <td>{{ cell }}</td>
                                                    <td>{{ count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        {% elif q_analytics.question.type in ['date', 'time'] %}
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Всего ответов:</strong> {{ q_analytics.data|length }}</p>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-outline-primary btn-sm" onclick="showTextAnswers({{ q_analytics.question.id }})">
                                        <i class="fas fa-eye"></i> Показать ответы
                                    </button>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Аналитика для этого типа вопроса пока не поддерживается
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для детального просмотра -->
<div class="modal fade" id="questionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детальный анализ вопроса</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="questionModalBody">
                <!-- Контент будет загружен динамически -->
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для текстовых ответов -->
<div class="modal fade" id="textAnswersModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Текстовые ответы</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="textAnswersModalBody">
                <!-- Контент будет загружен динамически -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Данные для графиков
const timeAnalytics = {{ analytics.time_analytics | tojson if analytics.time_analytics else '{}' }};
const questionAnalytics = {{ analytics.question_analytics | tojson if analytics.question_analytics else '[]' }};

document.addEventListener('DOMContentLoaded', function() {
    // График по дням
    if (timeAnalytics.daily) {
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        const dailyData = Object.entries(timeAnalytics.daily).map(([date, count]) => ({
            x: date,
            y: count
        }));
        
        new Chart(dailyCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Ответы по дням',
                    data: dailyData,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // График по часам
    if (timeAnalytics.hourly) {
        const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
        const hourlyData = Object.entries(timeAnalytics.hourly).map(([hour, count]) => ({
            x: hour,
            y: count
        }));
        
        new Chart(hourlyCtx, {
            type: 'bar',
            data: {
                labels: hourlyData.map(d => d.x + ':00'),
                datasets: [{
                    label: 'Ответы по часам',
                    data: hourlyData.map(d => d.y),
                    backgroundColor: 'rgba(220, 53, 69, 0.8)',
                    borderColor: '#dc3545',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Графики рейтингов и шкал
    questionAnalytics.forEach(q => {
        if ((q.question.type === 'rating' || q.question.type === 'scale') && q.data && q.data.distribution) {
            const ratingCtx = document.getElementById('ratingChart' + q.question.id);
            if (ratingCtx) {
                const distribution = q.data.distribution;
                new Chart(ratingCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(distribution),
                        datasets: [{
                            label: 'Распределение оценок',
                            data: Object.values(distribution),
                            backgroundColor: 'rgba(220, 53, 69, 0.8)',
                            borderColor: '#dc3545',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }
    });
});

function showQuestionChart(questionId) {
    // Показать график вопроса
    console.log('Показать график для вопроса:', questionId);
}

function showQuestionDetails(questionId) {
    // Показать детали вопроса
    const question = questionAnalytics.find(q => q.question.id === questionId);
    if (question) {
        const modalBody = document.getElementById('questionModalBody');
        let detailsHtml = `
            <h6>${question.question.text}</h6>
            <p><strong>Тип:</strong> ${getQuestionTypeName(question.question.type)}</p>
            <p><strong>Всего ответов:</strong> ${question.total_answers}</p>
            <p><strong>Процент ответов:</strong> ${question.response_rate.toFixed(1)}%</p>
            <p><strong>Обязательный:</strong> ${question.question.is_required ? 'Да' : 'Нет'}</p>
        `;
        
        // Добавляем специфичную информацию для разных типов вопросов
        if (question.question.type in ['single_choice', 'multiple_choice', 'dropdown']) {
            if (question.question.options) {
                const options = JSON.parse(question.question.options);
                detailsHtml += `<p><strong>Варианты ответов:</strong> ${options.join(', ')}</p>`;
            }
        } else if (question.question.type in ['rating', 'scale']) {
            detailsHtml += `<p><strong>Диапазон:</strong> от ${question.question.rating_min || 1} до ${question.question.rating_max || 10}</p>`;
            if (question.question.rating_labels) {
                const labels = JSON.parse(question.question.rating_labels);
                if (labels.length >= 2) {
                    detailsHtml += `<p><strong>Подписи:</strong> ${labels[0]} - ${labels[1]}</p>`;
                }
            }
        } else if (question.question.type in ['grid', 'checkbox_grid']) {
            if (question.question.grid_rows && question.question.grid_columns) {
                const rows = JSON.parse(question.question.grid_rows);
                const cols = JSON.parse(question.question.grid_columns);
                detailsHtml += `<p><strong>Строки:</strong> ${rows.join(', ')}</p>`;
                detailsHtml += `<p><strong>Столбцы:</strong> ${cols.join(', ')}</p>`;
            }
        }
        
        modalBody.innerHTML = detailsHtml;
        new bootstrap.Modal(document.getElementById('questionModal')).show();
    }
}

function showTextAnswers(questionId) {
    // Показать текстовые ответы
    const question = questionAnalytics.find(q => q.question.id === questionId);
    if (question && question.data) {
        const modalBody = document.getElementById('textAnswersModalBody');
        let answersHtml = `<h6>${question.question.text}</h6><div class="mt-3">`;
        
        if (question.question.type in ['text', 'text_paragraph'] && question.data.answers) {
            answersHtml += `<div class="list-group">`;
            answersHtml += question.data.answers.map(answer => `
                <div class="list-group-item">
                    <p class="mb-0">${answer}</p>
                </div>
            `).join('');
            answersHtml += `</div>`;
        } else if (question.question.type in ['date', 'time'] && Array.isArray(question.data)) {
            answersHtml += `<div class="list-group">`;
            answersHtml += question.data.map(answer => `
                <div class="list-group-item">
                    <p class="mb-0">${answer}</p>
                </div>
            `).join('');
            answersHtml += `</div>`;
        } else {
            answersHtml += '<p class="text-muted">Нет ответов для отображения</p>';
        }
        
        answersHtml += '</div>';
        modalBody.innerHTML = answersHtml;
        new bootstrap.Modal(document.getElementById('textAnswersModal')).show();
    }
}

function getQuestionTypeName(type) {
    const names = {
        'text': 'Текст (строка)',
        'text_paragraph': 'Текст (Абзац)',
        'single_choice': 'Один из списка',
        'multiple_choice': 'Несколько из списка',
        'dropdown': 'Раскрывающийся список',
        'scale': 'Шкала',
        'rating': 'Оценка',
        'grid': 'Сетка',
        'checkbox_grid': 'Сетка из флажков',
        'date': 'Дата',
        'time': 'Время'
    };
    return names[type] || 'Неизвестный тип';
}

function getQuestionIcon(type) {
    const icons = {
        'text': 'font',
        'text_paragraph': 'align-left',
        'single_choice': 'list-ul',
        'multiple_choice': 'check-square',
        'dropdown': 'chevron-down',
        'scale': 'sliders-h',
        'rating': 'star',
        'grid': 'th',
        'checkbox_grid': 'th-list',
        'date': 'calendar',
        'time': 'clock'
    };
    return icons[type] || 'question';
}
</script>
{% endblock %}